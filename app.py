[TRUNCADO: Aquí va el código completo que actualicé anteriormente]